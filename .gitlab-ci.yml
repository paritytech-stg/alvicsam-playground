stages:
  - fmt
  - build
  - test
  - deploy

variables:
  CI_IMAGE:                        "paritytech/ci-linux:production"
  TEST_GLOBAL_VAR:                 "lalala"

default:
  image:                           $CI_IMAGE
  retry:
    max: 2
    when:
      - runner_system_failure
      - unknown_failure
      - api_failure
  interruptible:                   true
  tags:
    - testlab-docker

.test-refs:                        &test-refs
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_REF_NAME == "master"
    - if: $CI_COMMIT_REF_NAME =~ /^[0-9]+$/                         # PRs
    - if: $CI_COMMIT_REF_NAME =~ /^some-release-v[0-9]+\.[0-9]+.*$/              # i.e. some-release-v1.0, some-release-v2.1rc1

cargo-fmt:
  stage:                           fmt
  <<:                              *test-refs
  variables:
    GIT_STRATEGY:                  none
  script:
    - cargo fmt --check && export NEED_FMT=0 || export NEED_FMT=1
    - if [[ $NEED_FMT == 0  ]]; then
        echo "ok";
      else
        export PR_BRANCH="as-rust";
        sleep 1000;
        echo "--- we need to push some changes ----";
        echo "--- setup ssh -----------------------";
        rm -rf .git/config;
        echo "------ set user ---------------------";
        git config -f .git/config user.email "${GITHUB_EMAIL}";
        echo "------ set password -----------------";
        git config -f .git/config user.name "${GITHUB_USER}";
        echo "------ set remote repo --------------";
        git config -f .git/config remote.origin.url "https://${GITHUB_TOKEN}@github.com/tripleightech/alvicsam-playground.git";
        echo "------ git fetch --------------------";
        git config -f .git/config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*";
        git fetch origin $PR_BRANCH;
        echo "------ git checkout -----------------";
        git checkout $PR_BRANCH;
        echo "------ git pull ---------------------";
        git pull origin $PR_BRANCH;
        echo "--- cargo fmt -----------------------";
        cargo fmt;
        echo "----  git status --------------------";
        git status;
        echo "----  git add -----------------------";
        git add *;
        echo "----  git commit --------------------";
        git commit --amend -m "[ci] apply cargo fmt";
        echo "----  git status --------------------";
        git status;
        git push origin $PR_BRANCH;
      fi

build-job:
  stage:                           build
  <<:                              *test-refs
  script:
    - cargo build

