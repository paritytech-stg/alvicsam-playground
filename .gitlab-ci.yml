stages:
  - build
  - test
  - deploy
  - publish

variables:
  CI_IMAGE: "paritytech/ci-unified:bullseye-1.74.0-2023-11-01-v20231204"
  TEST_GLOBAL_VAR: "lalala"

default:
  retry:
    max: 2
    when:
      - runner_system_failure
      - unknown_failure
      - api_failure
  interruptible: true

.kubernetes-env:
  image: $CI_IMAGE
  tags:
    - kubernetes-parity-build

.test-refs:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_REF_NAME == "master"
    - if: $CI_COMMIT_REF_NAME =~ /^[0-9]+$/ # PRs
    - if: $CI_COMMIT_REF_NAME =~ /^gh-readonly-queue.*$/ # merge queues
    - if: $CI_COMMIT_REF_NAME =~ /^release-parachains-v[0-9]+\.[0-9]+.*$/ # i.e. v1.0, v2.1rc1

.build-job:
  stage: build
  extends:
    - .kubernetes-env
    - .test-refs
  variables:
    TEST_LOCAL_VAR: "ololo"
  script:
    - echo ok

.tests:
  stage: test
  extends: .kubernetes-env
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^[0-9]+$/ # PRs
    - if: $CI_COMMIT_REF_NAME == "master"
  script:
    - echo "run always (but not with tags)"
    - sleep 30

codecov:
  stage: test
  extends: .kubernetes-env
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^[0-9]+$/ # PRs
    - if: $CI_COMMIT_REF_NAME == "master"
  script:
    - rustup component add llvm-tools-preview
    - CARGO_INCREMENTAL=0 RUSTFLAGS='-Cinstrument-coverage' LLVM_PROFILE_FILE='cargo-test-%p-%m.profraw' time cargo nextest run --release
    - mkdir -p target/coverage
    - grcov . --binary-path ./target/release/deps/ -s . -t lcov --branch --ignore-not-existing --ignore '../*' --ignore "/*" -o target/coverage/tests.lcov
    - codecov --token "${CODECOV_TOKEN}" --file target/coverage/tests.lcov

.publish-dry-run:
  stage: publish
  extends: .kubernetes-env
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^[0-9]+$/ # PRs
  script:
    - echo "run only in PR"

.publish-crate:
  stage: publish
  extends: .kubernetes-env
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /^v.[0-9]+\.[0-9]+.*$/ # i.e. v.1.0, v.2.1rc1
  script:
    - echo "run only when tag/release is set"
